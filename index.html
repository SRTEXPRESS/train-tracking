<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>SRT Train Live Tracking</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body { margin:0; }
  #map { height:100vh; }
</style>
</head>
<body>

<div id="map"></div>

<script>

// ====== ตั้งค่า ThingSpeak ======
const channelID = 3195220;
const readAPI = "KA3TZR7BO86GX3BP";

// ====== สร้างแผนที่เริ่มต้น (กรุงเทพ) ======
var map = L.map('map').setView([13.7367, 100.5231], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

// ====== ไอคอนรถไฟแบบ SVG ======
var trainIcon = L.divIcon({
  html: `
  <svg width="50" height="50" viewBox="0 0 24 24" fill="red">
    <path d="M12 2C8 2 6 3 6 6V13C6 15 7 16 8 17L6 19V20H18V19L16 17C17 16 18 15 18 13V6C18 3 16 2 12 2ZM8 6H16V10H8V6ZM9 14C8.45 14 8 13.55 8 13C8 12.45 8.45 12 9 12C9.55 12 10 12.45 10 13C10 13.55 9.55 14 9 14ZM15 14C14.45 14 14 13.55 14 13C14 12.45 14.45 12 15 12C15.55 12 16 12.45 16 13C16 13.55 15.55 14 15 14Z"/>
  </svg>
  `,
  className: '',
  iconSize: [50, 50],
  iconAnchor: [25, 25]
});

var marker;

// ====== ฟังก์ชันโหลด GPS ล่าสุด ======
async function loadGPS() {

  try {

    const url = `https://api.thingspeak.com/channels/${channelID}/feeds/last.json?api_key=${readAPI}`;
    const response = await fetch(url);
    const data = await response.json();

    let lat = parseFloat(data.field1);
    let lon = parseFloat(data.field2);

    if (isNaN(lat) || isNaN(lon)) {
      console.log("Invalid GPS Data");
      return;
    }

    if (!marker) {
      marker = L.marker([lat, lon], {icon: trainIcon}).addTo(map);
    } else {
      marker.setLatLng([lat, lon]);
    }

    map.setView([lat, lon], 15);

  } catch (error) {
    console.log("Error:", error);
  }
}

// โหลดครั้งแรก
loadGPS();

// อัปเดตทุก 20 วินาที
setInterval(loadGPS, 20000);

</script>

</body>
</html>
