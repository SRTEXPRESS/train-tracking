<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>SRT Train Tracking</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  body { margin:0; }
  #map { height:100vh; }

  .infoBox {
    position:absolute;
    top:15px;
    left:15px;
    background:white;
    padding:12px;
    border-radius:8px;
    box-shadow:0 0 10px rgba(0,0,0,0.3);
    font-family:Arial;
    z-index:1000;
  }
</style>
</head>
<body>

<div id="map"></div>

<div class="infoBox">
  <b>üöÜ Train Status</b><br>
  <span id="lat">Latitude: -</span><br>
  <span id="lon">Longitude: -</span><br>
  <span id="time">Last Update: -</span>
</div>

<script>

// ====== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ThingSpeak ======
const channelID = 3195220;
const readAPI = "KA3TZR7BO86GX3BP";

// ====== ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ======
var map = L.map('map').setView([13.7367, 100.5231], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

// ====== ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏£‡∏ñ‡πÑ‡∏ü ======
var trainIcon = L.icon({
  iconUrl: 'https://cdn-icons-png.flaticon.com/512/71/71368.png',
  iconSize: [40, 40],
  iconAnchor: [20, 20]
});

var marker;
var polyline;

// ====== ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GPS ======
async function loadGPS() {

  const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPI}&results=20`;

  const response = await fetch(url);
  const data = await response.json();

  if (!data.feeds || data.feeds.length === 0) {
    console.log("No GPS Data");
    return;
  }

  let coords = [];

  data.feeds.forEach(feed => {
    let lat = parseFloat(feed.field1);
    let lon = parseFloat(feed.field2);

    if (!isNaN(lat) && !isNaN(lon)) {
      coords.push([lat, lon]);
    }
  });

  if (coords.length === 0) {
    console.log("Invalid GPS");
    return;
  }

  // ===== ‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î =====
  let latest = coords[coords.length - 1];
  let lat = latest[0];
  let lon = latest[1];

  // ===== ‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ =====
  if (marker) map.removeLayer(marker);
  if (polyline) map.removeLayer(polyline);

  // ===== ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á =====
  polyline = L.polyline(coords, {color:'blue', weight:4}).addTo(map);

  // ===== ‡∏ß‡∏≤‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏£‡∏ñ‡πÑ‡∏ü =====
  marker = L.marker([lat, lon], {icon: trainIcon}).addTo(map);

  // ===== ‡∏ã‡∏π‡∏°‡πÑ‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î =====
  map.setView([lat, lon], 15);

  // ===== ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• =====
  document.getElementById("lat").innerHTML = "Latitude: " + lat;
  document.getElementById("lon").innerHTML = "Longitude: " + lon;
  document.getElementById("time").innerHTML =
    "Last Update: " + new Date().toLocaleString();
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
loadGPS();

// üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏∏‡∏Å 20 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
setInterval(loadGPS, 20000);

</script>

</body>
</html>
