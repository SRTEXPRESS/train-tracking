<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>SRT Train Live Tracking</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body { margin:0; }
  #map { height:100vh; }

  .infoBox {
    position:absolute;
    top:15px;
    left:15px;
    background:white;
    padding:15px;
    border-radius:10px;
    box-shadow:0 0 15px rgba(0,0,0,0.3);
    font-family:Arial;
    z-index:1000;
    width:240px;
  }

  .title {
    font-weight:bold;
    margin-bottom:8px;
  }
</style>
</head>
<body>

<div id="map"></div>

<div class="infoBox">
  <div class="title">üöÜ Train Status</div>
  <div id="speed">Speed: - km/h</div>
  <div id="latlon">Lat/Lon: -</div>
  <div id="time">Last Update: -</div>
</div>

<script>

const channelID = 3195220;
const readAPI = "KA3TZR7BO86GX3BP";

var map = L.map('map').setView([13.7367, 100.5231], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

// ===== ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏£‡∏ñ‡πÑ‡∏ü =====
var trainIcon = L.divIcon({
  html: `
  <svg width="50" height="50" viewBox="0 0 24 24" fill="red">
    <path d="M12 2C8 2 6 3 6 6V13C6 15 7 16 8 17L6 19V20H18V19L16 17C17 16 18 15 18 13V6C18 3 16 2 12 2ZM8 6H16V10H8V6ZM9 14C8.45 14 8 13.55 8 13C8 12.45 8.45 12 9 12C9.55 12 10 12.45 10 13C10 13.55 9.55 14 9 14ZM15 14C14.45 14 14 13.55 14 13C14 12.45 14.45 12 15 12C15.55 12 16 12.45 16 13C16 13.55 15.55 14 15 14Z"/>
  </svg>
  `,
  className: '',
  iconSize: [50, 50],
  iconAnchor: [25, 25]
});

var marker;

// ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (Haversine) =====
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // km
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;

  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

async function loadGPS() {

  const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPI}&results=2`;
  const response = await fetch(url);
  const data = await response.json();

  if (!data.feeds || data.feeds.length < 2) return;

  let f1 = data.feeds[data.feeds.length - 1];
  let f0 = data.feeds[data.feeds.length - 2];

  let lat1 = parseFloat(f1.field1);
  let lon1 = parseFloat(f1.field2);
  let lat0 = parseFloat(f0.field1);
  let lon0 = parseFloat(f0.field2);

  if (isNaN(lat1) || isNaN(lon1) || isNaN(lat0) || isNaN(lon0)) return;

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
  let distance = getDistance(lat0, lon0, lat1, lon1);

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
  let t1 = new Date(f1.created_at);
  let t0 = new Date(f0.created_at);
  let timeDiff = (t1 - t0) / (1000 * 60 * 60);

  let speed = 0;
  if (timeDiff > 0) {
    speed = distance / timeDiff;
  }

  if (!marker) {
    marker = L.marker([lat1, lon1], {icon: trainIcon}).addTo(map);
  } else {
    marker.setLatLng([lat1, lon1]);
  }

  map.setView([lat1, lon1], 15);

  document.getElementById("speed").innerHTML =
    "Speed: " + speed.toFixed(2) + " km/h";

  document.getElementById("latlon").innerHTML =
    "Lat/Lon: " + lat1.toFixed(5) + ", " + lon1.toFixed(5);

  document.getElementById("time").innerHTML =
    "Last Update: " + t1.toLocaleString();
}

loadGPS();
setInterval(loadGPS, 20000);

</script>

</body>
</html>
